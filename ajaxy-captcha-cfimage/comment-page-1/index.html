<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>Stillnet Studios  &raquo; Blog Archive   &raquo; A secure, ajaxy captcha with cfimage</title>

<meta name="generator" content="WordPress 6.1.1"> <!-- leave this for stats -->

<link rel="stylesheet" href="/wp-content/themes/evanescence-12/style.css" type="text/css" media="screen">
<link rel="alternate" type="application/rss+xml" title="Stillnet Studios RSS Feed" href="/feed/">
<link rel="pingback" href="/xmlrpc.php">

<meta name="robots" content="max-image-preview:large">
				
	<script type="text/javascript">//<![CDATA[
	// Google Analytics for WordPress by Yoast v4.2.3 | http://yoast.com/wordpress/google-analytics/
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount','UA-1413191-1']);
	_gaq.push(['_trackPageview']);
	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
	//]]></script>
<link rel="alternate" type="application/rss+xml" title="Stillnet Studios &raquo; A secure, ajaxy captcha with cfimage Comments Feed" href="/ajaxy-captcha-cfimage/feed/">
<script type="text/javascript">
window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/14.0.0\/svg\/","svgExt":".svg","source":{"concatemoji":"httpwww.stillnetstudios.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=6.1.1"}};
/*! This file is auto-generated */
!function(e,a,t){var n,r,o,i=a.createElement("canvas"),p=i.getContext&&i.getContext("2d");function s(e,t){var a=String.fromCharCode,e=(p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,e),0,0),i.toDataURL());return p.clearRect(0,0,i.width,i.height),p.fillText(a.apply(this,t),0,0),e===i.toDataURL()}function c(e){var t=a.createElement("script");t.src=e,t.defer=t.type="text/javascript",a.getElementsByTagName("head")[0].appendChild(t)}for(o=Array("flag","emoji"),t.supports={everything:!0,everythingExceptFlag:!0},r=0;r<o.length;r++)t.supports[o[r]]=function(e){if(p&&p.fillText)switch(p.textBaseline="top",p.font="600 32px Arial",e){case"flag":return s([127987,65039,8205,9895,65039],[127987,65039,8203,9895,65039])?!1:!s([55356,56826,55356,56819],[55356,56826,8203,55356,56819])&&!s([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]);case"emoji":return!s([129777,127995,8205,129778,127999],[129777,127995,8203,129778,127999])}return!1}(o[r]),t.supports.everything=t.supports.everything&&t.supports[o[r]],"flag"!==o[r]&&(t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&t.supports[o[r]]);t.supports.everythingExceptFlag=t.supports.everythingExceptFlag&&!t.supports.flag,t.DOMReady=!1,t.readyCallback=function(){t.DOMReady=!0},t.supports.everything||(n=function(){t.readyCallback()},a.addEventListener?(a.addEventListener("DOMContentLoaded",n,!1),e.addEventListener("load",n,!1)):(e.attachEvent("onload",n),a.attachEvent("onreadystatechange",function(){"complete"===a.readyState&&t.readyCallback()})),(e=t.source||{}).concatemoji?c(e.concatemoji):e.wpemoji&&e.twemoji&&(c(e.twemoji),c(e.wpemoji)))}(window,document,window._wpemojiSettings);
</script>
<style type="text/css">img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 0.07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}</style>
	<link rel="stylesheet" id="wp-block-library-css" href="/wp-includes/css/dist/block-library/style.min.css?ver=6.1.1" type="text/css" media="all">
<link rel="stylesheet" id="classic-theme-styles-css" href="/wp-includes/css/classic-themes.min.css?ver=1" type="text/css" media="all">
<style id="global-styles-inline-css" type="text/css">body{--wp--preset--color--black: #000000;--wp--preset--color--cyan-bluish-gray: #abb8c3;--wp--preset--color--white: #ffffff;--wp--preset--color--pale-pink: #f78da7;--wp--preset--color--vivid-red: #cf2e2e;--wp--preset--color--luminous-vivid-orange: #ff6900;--wp--preset--color--luminous-vivid-amber: #fcb900;--wp--preset--color--light-green-cyan: #7bdcb5;--wp--preset--color--vivid-green-cyan: #00d084;--wp--preset--color--pale-cyan-blue: #8ed1fc;--wp--preset--color--vivid-cyan-blue: #0693e3;--wp--preset--color--vivid-purple: #9b51e0;--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple: linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan: linear-gradient(135deg,rgb(122,220,180) 0%,rgb(0,208,130) 100%);--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange: linear-gradient(135deg,rgba(252,185,0,1) 0%,rgba(255,105,0,1) 100%);--wp--preset--gradient--luminous-vivid-orange-to-vivid-red: linear-gradient(135deg,rgba(255,105,0,1) 0%,rgb(207,46,46) 100%);--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray: linear-gradient(135deg,rgb(238,238,238) 0%,rgb(169,184,195) 100%);--wp--preset--gradient--cool-to-warm-spectrum: linear-gradient(135deg,rgb(74,234,220) 0%,rgb(151,120,209) 20%,rgb(207,42,186) 40%,rgb(238,44,130) 60%,rgb(251,105,98) 80%,rgb(254,248,76) 100%);--wp--preset--gradient--blush-light-purple: linear-gradient(135deg,rgb(255,206,236) 0%,rgb(152,150,240) 100%);--wp--preset--gradient--blush-bordeaux: linear-gradient(135deg,rgb(254,205,165) 0%,rgb(254,45,45) 50%,rgb(107,0,62) 100%);--wp--preset--gradient--luminous-dusk: linear-gradient(135deg,rgb(255,203,112) 0%,rgb(199,81,192) 50%,rgb(65,88,208) 100%);--wp--preset--gradient--pale-ocean: linear-gradient(135deg,rgb(255,245,203) 0%,rgb(182,227,212) 50%,rgb(51,167,181) 100%);--wp--preset--gradient--electric-grass: linear-gradient(135deg,rgb(202,248,128) 0%,rgb(113,206,126) 100%);--wp--preset--gradient--midnight: linear-gradient(135deg,rgb(2,3,129) 0%,rgb(40,116,252) 100%);--wp--preset--duotone--dark-grayscale: url('#wp-duotone-dark-grayscale');--wp--preset--duotone--grayscale: url('#wp-duotone-grayscale');--wp--preset--duotone--purple-yellow: url('#wp-duotone-purple-yellow');--wp--preset--duotone--blue-red: url('#wp-duotone-blue-red');--wp--preset--duotone--midnight: url('#wp-duotone-midnight');--wp--preset--duotone--magenta-yellow: url('#wp-duotone-magenta-yellow');--wp--preset--duotone--purple-green: url('#wp-duotone-purple-green');--wp--preset--duotone--blue-orange: url('#wp-duotone-blue-orange');--wp--preset--font-size--small: 13px;--wp--preset--font-size--medium: 20px;--wp--preset--font-size--large: 36px;--wp--preset--font-size--x-large: 42px;--wp--preset--spacing--20: 0.44rem;--wp--preset--spacing--30: 0.67rem;--wp--preset--spacing--40: 1rem;--wp--preset--spacing--50: 1.5rem;--wp--preset--spacing--60: 2.25rem;--wp--preset--spacing--70: 3.38rem;--wp--preset--spacing--80: 5.06rem;}:where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}.has-black-color{color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-color{color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-color{color: var(--wp--preset--color--white) !important;}.has-pale-pink-color{color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-color{color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-color{color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-color{color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-color{color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-color{color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-color{color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-color{color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-color{color: var(--wp--preset--color--vivid-purple) !important;}.has-black-background-color{background-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-background-color{background-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.has-pale-pink-background-color{background-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-background-color{background-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-background-color{background-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-background-color{background-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-background-color{background-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-background-color{background-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-background-color{background-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-background-color{background-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-background-color{background-color: var(--wp--preset--color--vivid-purple) !important;}.has-black-border-color{border-color: var(--wp--preset--color--black) !important;}.has-cyan-bluish-gray-border-color{border-color: var(--wp--preset--color--cyan-bluish-gray) !important;}.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}.has-pale-pink-border-color{border-color: var(--wp--preset--color--pale-pink) !important;}.has-vivid-red-border-color{border-color: var(--wp--preset--color--vivid-red) !important;}.has-luminous-vivid-orange-border-color{border-color: var(--wp--preset--color--luminous-vivid-orange) !important;}.has-luminous-vivid-amber-border-color{border-color: var(--wp--preset--color--luminous-vivid-amber) !important;}.has-light-green-cyan-border-color{border-color: var(--wp--preset--color--light-green-cyan) !important;}.has-vivid-green-cyan-border-color{border-color: var(--wp--preset--color--vivid-green-cyan) !important;}.has-pale-cyan-blue-border-color{border-color: var(--wp--preset--color--pale-cyan-blue) !important;}.has-vivid-cyan-blue-border-color{border-color: var(--wp--preset--color--vivid-cyan-blue) !important;}.has-vivid-purple-border-color{border-color: var(--wp--preset--color--vivid-purple) !important;}.has-vivid-cyan-blue-to-vivid-purple-gradient-background{background: var(--wp--preset--gradient--vivid-cyan-blue-to-vivid-purple) !important;}.has-light-green-cyan-to-vivid-green-cyan-gradient-background{background: var(--wp--preset--gradient--light-green-cyan-to-vivid-green-cyan) !important;}.has-luminous-vivid-amber-to-luminous-vivid-orange-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-amber-to-luminous-vivid-orange) !important;}.has-luminous-vivid-orange-to-vivid-red-gradient-background{background: var(--wp--preset--gradient--luminous-vivid-orange-to-vivid-red) !important;}.has-very-light-gray-to-cyan-bluish-gray-gradient-background{background: var(--wp--preset--gradient--very-light-gray-to-cyan-bluish-gray) !important;}.has-cool-to-warm-spectrum-gradient-background{background: var(--wp--preset--gradient--cool-to-warm-spectrum) !important;}.has-blush-light-purple-gradient-background{background: var(--wp--preset--gradient--blush-light-purple) !important;}.has-blush-bordeaux-gradient-background{background: var(--wp--preset--gradient--blush-bordeaux) !important;}.has-luminous-dusk-gradient-background{background: var(--wp--preset--gradient--luminous-dusk) !important;}.has-pale-ocean-gradient-background{background: var(--wp--preset--gradient--pale-ocean) !important;}.has-electric-grass-gradient-background{background: var(--wp--preset--gradient--electric-grass) !important;}.has-midnight-gradient-background{background: var(--wp--preset--gradient--midnight) !important;}.has-small-font-size{font-size: var(--wp--preset--font-size--small) !important;}.has-medium-font-size{font-size: var(--wp--preset--font-size--medium) !important;}.has-large-font-size{font-size: var(--wp--preset--font-size--large) !important;}.has-x-large-font-size{font-size: var(--wp--preset--font-size--x-large) !important;}
.wp-block-navigation a:where(:not(.wp-element-button)){color: inherit;}
:where(.wp-block-columns.is-layout-flex){gap: 2em;}
.wp-block-pullquote{font-size: 1.5em;line-height: 1.6;}</style>
<link rel="https://api.w.org/" href="/wp-json/">
<link rel="alternate" type="application/json" href="/wp-json/wp/v2/posts/460">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml">
<meta name="generator" content="WordPress 6.1.1">
<link rel="canonical" href="/ajaxy-captcha-cfimage/comment-page-1/#comments">
<link rel="shortlink" href="/?p=460">
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Fajaxy-captcha-cfimage%2F">
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Fajaxy-captcha-cfimage%2F&#038;format=xml">
</head>

<body>
<div id="page">

<div id="header">
<div><div>	
	<div class="header-title">
		<h1><a href="/" title="Stillnet Studios: Web development notes and commentary from Ryan Stille">Stillnet Studios</a></h1>
		<p>Web development notes and commentary from Ryan Stille</p>
	</div> 
	<!-- Search box (If you prefer having search form as a sidebar widget, remove this block) -->
	<div class="search">
		<form method="get" id="searchform" action="http://www.stillnetstudios.com/">
<input type="text" size="12" name="s" id="s" value="search..." onblur="if(this.value=='') this.value='search...';" onfocus="if(this.value=='search...') this.value='';">
</form>
	</div> 
	<!-- Search ends here-->
</div></div>	
</div>
<div id="wrapper">

	<div id="content">

			
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="/free-railo-hosting/" rel="prev">Free Railo CFML Hosting</a>
</div>
			<div class="alignright">
<a href="/securing-blue-dragon-settings-file/" rel="next">Securing your open blue dragon settings file</a> &raquo;</div>
		</div>

		<div class="post" id="post-460">
			<div class="post-title"><div>
				<h2><a href="/ajaxy-captcha-cfimage/" rel="bookmark" title="Permanent Link to A secure, ajaxy captcha with cfimage">A secure, ajaxy captcha with cfimage</a></h2>
			</div></div>
			<div class="post-entry">
				<p>A while back I had to implement a captcha on a client&#8217;s site.   The site owner wanted a simple small captcha (that ruled out <a href="http://recaptcha.net/">reCAPTCHA</a>).  We decided to try the new captcha features of ColdFusion8.  What you may not realize is that the new captcha feature does not provide the whole captcha <em>system</em>, instead it merely can create captcha images.  Its up to you how you implement your captcha system.</p>
<p>Before I get too far just let me state for the record that I <em>dislike</em> captchas and will be happy when they are looked upon like we look at the &lt;blink&gt; tag now.  So you don&#8217;t need to leave comments telling me how I shouldn&#8217;t be using a captcha in the first place. 🙂  The client specifically wanted this feature at this point in time.</p>
<p>I&#8217;ve seen some approaches that place the clear text value of the captcha in a hidden field.  Then when the form is submitted they compare that value against what the user had typed in.  I don&#8217;t feel this way is very secure.  It will stop simple bots, but you need to guard against more than just that.  Sometimes spammers code their bots to work against a specific site.  If they find your hidden clear text captcha value, they will easily grab it and use it to submit your form.  If this is a simple contact form then you might not have much to worry about, but if its a &#8220;send to a friend&#8221; feature &#8211; watch out, those are high value targets.</p>
<p>Encrypting the hidden value doesn&#8217;t help much either.  That adds one more step to what the spammer needs to do.  They will have to manually read one of your captcha images &#8211; then they have the clear text and encrypted values to your captcha system.    Now they can just submit that encrypted/plain text pair over and over again to your form.<br>
<span id="more-460"></span><br>
To really be secure you have to keep track of the captcha value on the server side.  I decided to use a database but you could also use an in-memory variable or even use the file system.  One of the requirements was to allow the user to ask for a new captcha image without having to reload the whole form.  That requires ajax, but cfimage has no built in facilities for easily using it through ajax.  But its not too hard to work around.  Here is a cfc I created to wrap all this up.  My storage and retrieval methods in here use a database but you could easily change them to use the application scope or whatever you like.  The important part is to delete the captcha from your system (database, application scope, whatever) after its been solved.  This will prevent an attacker from manually decoding one captcha and then using that is his script.</p>
<pre><code>&lt;cfcomponent hint="Creates captchas using cfimage. Supports ajax refresh." output="false"&gt;

	&lt;cffunction name="createCaptcha" returntype="struct" hint="Returns a structure containing captcha properties." access="remote"&gt;
		&lt;cfargument name="minLength" default="6"&gt;
		&lt;cfargument name="maxLength" default="6"&gt;
		&lt;cfargument name="id" default="captchaImg" displayname="an ID to be used in the image tag."&gt;
		&lt;cfargument name="difficulty" default="low" hint="low | medium | high"&gt;

		&lt;cfset var local = {}&gt;
		&lt;cfset local.retVal = {}&gt;

		&lt;!--- declaring the keys this way ensures they will be delivered to the javascript in lower case, which it expects ---&gt;
		&lt;cfset local.retval["imgsrc"] = ""&gt;
		&lt;cfset local.retval["captcha_id"] = ""&gt;
		&lt;cfset local.retval["imgtag"] = ""&gt;

		&lt;cfset local.captchaText = makeCaptchaString(Arguments.minLength,Arguments.maxlength)&gt;

		&lt;!--- store the the captcha value in the DB. Get the ID so it can be used later to look up the captcha value ---&gt;
		&lt;cfquery name="local.qryCaptchaID" datasource="#Request.PrimaryDataSource#"&gt;
		SET NOCOUNT ON
		INSERT INTO captcha_values (captcha_value) VALUES
		(&lt;cfqueryparam value="#local.captchaText#" cfsqltype="cf_sql_varchar"&gt;)
		SELECT SCOPE_IDENTITY() AS captcha_id
		SET NOCOUNT OFF
		&lt;/cfquery&gt;

		&lt;!--- need to return the id ---&gt;
		&lt;cfset local.retval.captcha_id = local.qryCaptchaID.captcha_id&gt;

		&lt;cfsavecontent variable="local.retVal.imgtag"&gt;
			&lt;cfimage action="captcha" text="#local.captchaText#" difficulty="#Arguments.difficulty#"&gt;
		&lt;/cfsavecontent&gt;

		&lt;!--- tease out the image url, too.  This can be used to refresh the captcha with ajax. ---&gt;
		&lt;cfset local.regExResult = ReFind("src=""([^""]*)",local.retVal.imgtag,1,1)&gt;
		&lt;cfset local.retVal.imgsrc = Mid(local.retVal.imgtag,local.regExResult.pos[2],local.regExResult.len[2])&gt;

		&lt;!--- need to add an ID so we can manipulate with JavaScript. ---&gt;
		&lt;cfset local.retVal.imgtag = Replace(local.retVal.imgtag,"&lt;img","&lt;img id=""#Arguments.id#""","one")&gt;

		&lt;cfreturn local.retVal&gt;

	&lt;/cffunction&gt;

	&lt;cffunction name="getCaptchaText" returntype="string" hint="Returns the text associated with a captcha_id" access="public"&gt;
		&lt;cfargument name="captcha_id"&gt;

		&lt;cfset local = {}&gt;

		&lt;cfquery name="local.qryCaptcha" datasource="#Request.PrimaryDataSource#"&gt;
		SELECT captcha_value FROM captcha_values WHERE
		captcha_id = &lt;cfqueryparam value="#Arguments.captcha_id#" cfsqltype="cf_sql_integer"&gt;
		&lt;/cfquery&gt;

		&lt;cfif local.qryCaptcha.RecordCount EQ 0&gt;
			&lt;cfreturn ""&gt;
		&lt;/cfif&gt;

		&lt;!--- else we did find a captcha with this ID.  Now delete it, and return the value we found ---&gt;
		&lt;cfquery datasource="#Request.PrimaryDataSource#"&gt;
		DELETE FROM captcha_values WHERE
		captcha_id = &lt;cfqueryparam value="#Arguments.captcha_id#" cfsqltype="cf_sql_integer"&gt;
		&lt;/cfquery&gt;

		&lt;cfreturn local.qryCaptcha.captcha_value&gt;
	&lt;/cffunction&gt;

	&lt;cffunction name="makeCaptchaString" returnType="string" output="false" access="private"&gt;
		&lt;cfargument name="minLength"&gt;
		&lt;cfargument name="maxLength"&gt;

		&lt;!--- Don't use any characters that can be confused with each other ---&gt;
		&lt;cfset var chars = "23456789ABCDEFGHJKMNPQRS"&gt;
		&lt;cfset var length = randRange(Arguments.minLength,Arguments.maxLength)&gt;
		&lt;cfset var result = ""&gt;
		&lt;cfset var i = ""&gt;
		&lt;cfset var char = ""&gt;

		&lt;cfscript&gt;
		for(i=1; i &lt;= length; i++) {
			char = mid(chars, randRange(1, len(chars)),1);
			result&amp;=char;
		}
		&lt;/cfscript&gt;

		&lt;cfreturn result&gt;
	&lt;/cffunction&gt;
&lt;/cfcomponent&gt;</code></pre>
<p>Then in your form page you need a little javascript to allow the user to refresh the image.</p>
<pre><code>&lt;cfajaxproxy cfc="cfimageCaptcha" jsclassname="cfimageCaptcha"&gt;
&lt;script language="JavaScript"&gt;
function refreshCaptcha() {
	var jsCaptcha = new cfimageCaptcha();
	jsCaptcha.setCallbackHandler(populateCaptcha);
	jsCaptcha.createCaptcha();
}

function populateCaptcha(result) {
	var imgTag = document.getElementById("captchaImg");
	var hiddenTag = document.getElementById("captcha_id");

	imgTag.src = result.imgsrc;
	hiddenTag.value = result.captcha_id;

}
&lt;/script&gt;</code></pre>
<p>Then display the actual captcha on the page:</p>
<pre><code>&lt;cfset myCaptcha = CreateObject("component","cfimageCaptcha").createCaptcha()&gt;
#myCaptcha.imgtag#&lt;a href="JavaScript:refreshCaptcha()"&gt;change code&lt;/a&gt;&lt;br /&gt;
Type in the letters you see above: &lt;input type="text" name="captcha_value"&gt;
&lt;!--- need to pass along the ID of the captcha so we can look it up later ---&gt;
&lt;input type="hidden" name="captcha_id" id="captcha_id" value="#myCaptcha.captcha_id#"&gt;</code></pre>
<p>With me so far?  Now here is how you validate the captcha on your &#8220;action&#8221; page:</p>
<pre><code>&lt;cfif Form.captcha_value NEQ CreateObject("component","cfimageCaptcha").getCaptchaText(Form.captcha_id)&gt;
       &lt;p&gt;Throw your failed captcha error here!&lt;/p&gt;
&lt;/cfif&gt;</code></pre>
<p>Here is the SQL I used for my captcha table.</p>
<pre><code>CREATE TABLE [captcha_values] (
	[captcha_id] [int] IDENTITY (1, 1) NOT NULL ,
	[captcha_value] [varchar] (50) COLLATE SQL_Latin1_General_CP1_CI_AS NOT NULL ,
	[date_added] [smalldatetime] NULL CONSTRAINT [DF_captcha_values_date_added] DEFAULT (getdate())
) ON [PRIMARY]
GO</code></pre>
<p>And here is the query I run nightly to clear out abandoned entries that are older than 24 hours:</p>
<pre><code>DELETE FROM captcha_values WHERE
DateDiff(hour,date_added,CURRENT_TIMESTAMP) &gt; 24</code></pre>
							</div>
	
			<p class="post-meta">
					This entry was posted on 11 June 2009 at 10:05 pm					and is filed under <a href="/category/ajax-javascript/" rel="category tag">AJAX / JavaScript</a>, <a href="/category/coldfusion/" rel="category tag">ColdFusion</a>.
					You can follow any responses to this entry through the <a href="/ajaxy-captcha-cfimage/feed/">RSS 2.0</a> feed.

											Both comments and pings are currently closed.

					
			</p>
		</div>
	
<!-- You can start editing here. -->
<div id="comments">
	<h3>3 Comments</h3>

	<ol class="commentlist">

	
		<li class="alt" id="comment-533">
			<h4>Misty says:</h4>
			<p>Too Good Mate, I was Just going to try this method but i found your post, Cool Enough my clients also demand this Thanks</p>
						<small class="commentmetadata"><a href="#comment-533" title="">15 June 2009, 2:08 pm</a></small>
					</li>

	
	
		<li class="" id="comment-722">
			<h4>Marc says:</h4>
			<p>Thanks for this code, exactly what I was looking for. I&apos;ve expanded it quite a bit to be able to handle storing the captcha information in either the application or session scopes as well so that DB isn&apos;t needed.</p>
						<small class="commentmetadata"><a href="#comment-722" title="">14 September 2009, 8:56 pm</a></small>
					</li>

	
	
		<li class="alt" id="comment-2799">
			<h4>Toby Scheidegger says:</h4>
			<p>Thanks for your post almost dental implants overseas I have been looking at overseas dental services.Dental crowns overseas also seem to give great savings the results also seem to be excellent.Cheap dental work overseas seems to gathering popularity.</p>
						<small class="commentmetadata"><a href="#comment-2799" title="">15 April 2012, 9:49 am</a></small>
					</li>

	
	
	</ol>

 
</div>

	
	</div>

	<div id="sidebar">
	<div>
		<ul>
			<li id="text-3" class="widget widget_text">			<div class="textwidget"><center><img style="border: 1px solid gray;" src="/wp-content/uploads/2012/06/ryan-headshot-1.jpg" alt="Ryan Stille"></center></div>
		</li>
<li id="pages-3" class="widget widget_pages">
<h2 class="widgettitle">Pages</h2>

			<ul>
				<li class="page_item page-item-228"><a href="/about/">About Me</a></li>
<li class="page_item page-item-35"><a href="/projects/">My Projects</a></li>
			</ul>

			</li>
<li id="categories-3" class="widget widget_categories">
<h2 class="widgettitle">Article Categories</h2>

			<ul>
					<li class="cat-item cat-item-3">
<a href="/category/ajax-javascript/">AJAX / JavaScript</a>
</li>
	<li class="cat-item cat-item-4">
<a href="/category/bluedragon/">BlueDragon</a>
</li>
	<li class="cat-item cat-item-5">
<a href="/category/book-reviews/">Book Reviews</a>
</li>
	<li class="cat-item cat-item-6">
<a href="/category/coldfusion/">ColdFusion</a>
</li>
	<li class="cat-item cat-item-16">
<a href="/category/css/">CSS</a>
</li>
	<li class="cat-item cat-item-7">
<a href="/category/flex/">Flex</a>
</li>
	<li class="cat-item cat-item-8">
<a href="/category/linux/">Linux</a>
</li>
	<li class="cat-item cat-item-9">
<a href="/category/misc/">Misc</a>
</li>
	<li class="cat-item cat-item-10">
<a href="/category/railo/">Railo</a>
</li>
	<li class="cat-item cat-item-11">
<a href="/category/sql/">SQL</a>
</li>
	<li class="cat-item cat-item-12">
<a href="/category/system-administration/">System Administration</a>
</li>
	<li class="cat-item cat-item-13">
<a href="/category/tomcat/">Tomcat</a>
</li>
	<li class="cat-item cat-item-1">
<a href="/category/uncategorized/">Uncategorized</a>
</li>
	<li class="cat-item cat-item-14">
<a href="/category/web-development/">Web Development</a>
</li>
			</ul>

			</li>

		<li id="recent-posts-3" class="widget widget_recent_entries">
		<h2 class="widgettitle">Recent Posts</h2>

		<ul>
											<li>
					<a href="/coldfusion-formfield-as-array-cf10/">Accessing form fields as an array in CF10</a>
									</li>
											<li>
					<a href="/onerror-img-image-tag/">Did you know about the onerror attribute of the img tag?</a>
									</li>
											<li>
					<a href="/copying-sql-studio-excel-headers/">Copying data from SQL Studio to Excel</a>
									</li>
											<li>
					<a href="/dateconvert-utc-not-what-you-expect/">Using DateConvert to get a UTC timestamp may not return what you expect</a>
									</li>
											<li>
					<a href="/get-filename-before-calling-cffile/">Getting the client filename before using cffile</a>
									</li>
											<li>
					<a href="/jquery-snippet-to-get-all-input-values/">jQuery snippet to get all input values</a>
									</li>
											<li>
					<a href="/mura-404-page-not-working-in-iis7-fix-it-in-web-config/">Mura 404 page not working in IIS7 &#8211; fix it in web.config</a>
									</li>
											<li>
					<a href="/free-coldfusion-10-beta-hosting/">Free ColdFusion 10 beta hosting</a>
									</li>
											<li>
					<a href="/remove-spaces-columns-cfspreadsheet/">Removing spaces from columns in cfspreadsheet (or any query)</a>
									</li>
											<li>
					<a href="/online-code-formatters/">Online code formatters</a>
									</li>
											<li>
					<a href="/joining-two-tables-one-id/">Joining to one of two tables with one ID</a>
									</li>
											<li>
					<a href="/formatting-cfgrid-with-javascript/">Formatting CFGRID with JavaScript</a>
									</li>
											<li>
					<a href="/cf-form-array-comma-workaround/">Accessing ColdFusion form values as an array</a>
									</li>
											<li>
					<a href="/loading-fckeditor-dynamically/">Loading CFrichtext / FCKeditor on-the-fly</a>
									</li>
											<li>
					<a href="/url-rewriting-windows-2008-iis7/">Mura URL rewriting on Windows 2008 / IIS7</a>
									</li>
					</ul>

		</li>
<li id="linkcat-2" class="widget widget_links">
<h2 class="widgettitle">Blogroll</h2>

	<ul class="xoxo blogroll">
<li><a href="http://www.axelscript.com/" title="AxelScript &#8211; Flex development blog">Axel Jensen</a></li>
<li><a href="http://jake.cfwebtools.com/" title="ColdFusion/Flex development">Jake Churchill</a></li>
<li><a href="http://www.coldfusionmuse.com/" title="ColdFusion Muse">Mark Kruger</a></li>
<li><a href="http://www.henke.ws/" title="ColdFusion, TDD, Ant, Subversion, etc.">Mike Henke</a></li>

	</ul>
</li>

<li id="text-4" class="widget widget_text">
<h2 class="widgettitle">Donate</h2>
			<div class="textwidget">If my code has helped you and you'd like give a donation, you can do so using the button below.
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_donations">
<input type="hidden" name="business" value="ryan@stillnet.org">
<input type="hidden" name="lc" value="US">
<input type="hidden" name="item_name" value="Donation for helpful ColdFusion code">
<input type="hidden" name="currency_code" value="USD">
<input type="hidden" name="bn" value="PP-DonationsBF:btn_donateCC_LG.gif:NonHostedGuest">
<input type="image" src="https://www.paypal.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
</div>
		</li>
<li id="text-5" class="widget widget_text">			<div class="textwidget">
<br><br>
<img src="/wp-content/uploads/2010/01/acp_logo.gif">
</div>
		</li>
			
		</ul> 
	</div>
	</div>
</div> <!-- wrapper -->

<div id="footer"><div><div><div>

	<a href="/feed/">Entries (RSS)</a> and <a href="/comments/feed/">Comments (RSS)</a>. Valid <a href="http://validator.w3.org/check/referer" title="This page validates as XHTML 1.0 Transitional"><abbr title="eXtensible HyperText Markup Language">XHTML</abbr></a> and <a href="http://jigsaw.w3.org/css-validator/check/referer"><abbr title="Cascading Style Sheets">CSS</abbr></a>.<br>

	Powered by <a href="http://www.wpthemes360.com/">Wordpress Themes</a>. Theme <a href="http://srinig.com/wordpress-themes/evanescence/">Evanescence</a> by <a href="http://srinig.com/">Srini G</a>

	</div></div></div></div>

</div> <!-- page -->

</body>

</html>